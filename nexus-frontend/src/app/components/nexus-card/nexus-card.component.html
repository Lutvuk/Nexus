<div class="nexus-kanban-card group mb-1.5" [class.has-cover]="!!coverImage" [routerLink]="isEditing ? null : ['card', card.id]">

    <!-- Cover Image -->
    @if (coverImage) {
    <div class="h-20 mb-2 rounded-t -mx-3 -mt-2 overflow-hidden relative group-hover:brightness-110 transition-all">
        <img [src]="coverImage" class="w-full h-full object-cover" />
    </div>
    }

    <!-- Labels (Color bars) -->
    @if (card.labels && card.labels.length > 0) {
    <div class="flex flex-wrap gap-1 mb-2">
        @for (label of card.labels; track label.id) {
        <div class="nexus-label-bar" [style.background-color]="label.color" [title]="label.name"></div>
        }
    </div>
    }

    <!-- Card Content -->
    <div class="relative">
        @if (!isEditing) {
        <h3 (click)="enableEdit(); $event.stopPropagation()"
            class="text-[13px] font-medium text-white/90 pr-7 break-words leading-snug cursor-text hover:text-white transition-colors">
            {{ card.title }}
        </h3>

        <!-- Hover Edit Button (Pencil Icon) -->
        <button (click)="enableEdit(); $event.stopPropagation(); $event.preventDefault()"
            class="card-edit-btn w-6 h-6 flex items-center justify-center rounded bg-slate-700/80 hover:bg-slate-600 text-white/70 hover:text-white transition-all shadow-sm"
            title="Quick Edit">
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path>
                <path d="m15 5 4 4"></path>
            </svg>
        </button>
        } @else {
        <input type="text" [(ngModel)]="editedTitle" (blur)="saveEdit()" (keydown.enter)="saveEdit()"
            (keydown.escape)="cancelEdit()" autofocus
            class="w-full bg-white/10 border border-violet-500 rounded px-2 py-1 text-white focus:outline-none focus:ring-1 focus:ring-violet-500 text-sm">
        }
    </div>

    <!-- Metadata Badges -->
    <div class="flex items-center gap-2 mt-1.5 flex-wrap text-white/40 text-[10px]">
        <!-- Due Date -->
        @if (card.due_date) {
        <div class="flex items-center gap-1 px-1.5 py-0.5 rounded hover:bg-white/10 transition-colors"
            [ngClass]="{'bg-red-500/20 text-red-400': isOverdue(card.due_date)}">
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            <span>{{ card.due_date | date:'MMM d' }}</span>
        </div>
        }

        <!-- Checklist -->
        @if (card.checklists && card.checklists.length > 0) {
        <div class="flex items-center gap-1 px-1.5 py-0.5 rounded hover:bg-white/10 transition-colors"
            [class.text-green-400]="isChecklistComplete()">
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 11l3 3L22 4"></path>
                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
            </svg>
            <span>{{ getChecklistProgress() }}</span>
        </div>
        }

        <!-- Description indicator -->
        @if (card.description) {
        <div class="flex items-center gap-1 px-1 py-0.5" title="Has description">
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M17 10H7"></path>
                <path d="M21 6H3"></path>
                <path d="M21 14H3"></path>
                <path d="M17 18H7"></path>
            </svg>
        </div>
        }

        <!-- Members -->
        @if (card.members && card.members.length > 0) {
        <div class="flex -space-x-1 ml-auto">
            @for (member of card.members; track member.id) {
            <div class="w-5 h-5 rounded-full bg-gradient-to-br from-violet-500 to-purple-600 border border-[#1E293B] flex items-center justify-center text-[8px] font-bold text-white uppercase"
                [title]="member.name">
                @if (member.avatar_url) {
                <img [src]="resolveAvatarUrl(member.avatar_url)" class="w-full h-full object-cover rounded-full"
                    alt="Member Avatar">
                } @else {
                {{ getInitials(member.name) }}
                }
            </div>
            }
        </div>
        }
    </div>
</div>
