@if (isCollapsed) {
<!-- Collapsed Column: Trello-style thin vertical strip -->
<div class="w-10 h-[120px] flex-shrink-0 flex flex-col cursor-pointer group" (click)="toggleCollapse()">
    <div
        class="bg-black/30 hover:bg-black/40 rounded-xl border border-white/10 h-full flex flex-col items-center py-2 gap-2 transition-all">
        <!-- Card count badge -->
        <span
            class="text-[10px] font-bold text-white/50 bg-white/10 rounded-full w-6 h-6 flex items-center justify-center">
            {{ column.cards.length }}
        </span>
        <!-- Rotated column name -->
        <span class="text-xs font-semibold text-white/60 group-hover:text-white/80 transition-colors"
            style="writing-mode: vertical-rl; text-orientation: mixed; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-height: 200px;">
            {{ column.name }}
        </span>
        <!-- Expand hint icon -->
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="text-white/30 group-hover:text-white/60 transition-colors mt-auto">
            <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
    </div>
</div>
} @else {
<!-- Expanded Column: Full normal view -->
<div class="w-72 h-auto flex-shrink-0 flex flex-col max-h-[calc(100vh-170px)]">
    <!-- Column Header -->
    <div cdkDragHandle class="flex items-center justify-between mb-2 px-2 py-1.5 rounded-t-xl bg-black/25 border border-white/10 border-b-0 cursor-grab active:cursor-grabbing">
        <!-- Reorder Handle -->
        <div cdkDragHandle class="cursor-move text-white/20 hover:text-white/40 p-1 rounded hover:bg-white/5 mr-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2">
                <circle cx="9" cy="12" r="1" />
                <circle cx="9" cy="5" r="1" />
                <circle cx="9" cy="19" r="1" />
                <circle cx="15" cy="12" r="1" />
                <circle cx="15" cy="5" r="1" />
                <circle cx="15" cy="19" r="1" />
            </svg>
        </div>

        <div class="flex-1 min-w-0">
            @if (isEditingName) {
            <input type="text" [(ngModel)]="editedName" (blur)="saveNameEdit()" (keyup.enter)="saveNameEdit()"
                (keyup.escape)="cancelNameEdit()"
                class="w-full bg-white/10 border border-violet-500 rounded px-2 py-1 text-sm text-white focus:outline-none"
                autofocus>
            } @else {
            <h2 (click)="enableNameEdit()"
                class="font-semibold text-white/90 text-[13px] uppercase tracking-wide flex items-center gap-2 cursor-text group truncate">
                <span class="w-3 h-3 rounded-full bg-violet-500/50 border border-violet-400 shrink-0"></span>
                <span class="truncate">{{ column.name }}</span>
                <span
                    class="ml-auto text-xs text-white/40 bg-white/5 py-0.5 px-2 rounded-full group-hover:bg-white/10">{{
                    column.cards.length }}</span>
            </h2>
            @if (isOverWipLimit()) {
            <div class="mt-1 text-[10px] text-amber-300 bg-amber-500/15 border border-amber-500/30 rounded px-2 py-0.5 inline-flex items-center gap-1">
                <span>WIP warning:</span>
                <span class="font-bold">{{ column.cards.length }}/{{ wipLimit }}</span>
            </div>
            }
            }
        </div>

        <!-- Column Menu (3-dot) -->
        <div class="relative ml-2">
            <button (click)="showColumnMenu = !showColumnMenu"
                class="text-white/40 hover:text-white/70 transition-colors p-1 rounded hover:bg-white/5">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="5" r="1"></circle>
                    <circle cx="12" cy="12" r="1"></circle>
                    <circle cx="12" cy="19" r="1"></circle>
                </svg>
            </button>
            @if (showColumnMenu) {
            <div class="absolute right-0 top-8 w-48 bg-slate-900/95 backdrop-blur-xl border border-white/10 rounded-lg shadow-2xl z-50 py-1 overflow-hidden"
                (mouseleave)="showColumnMenu = false">
                <button (click)="toggleCollapse(); showColumnMenu = false"
                    class="w-full text-left px-4 py-2 text-sm text-white/70 hover:bg-white/10 hover:text-white transition-colors flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                    Collapse list
                </button>
                <button (click)="deleteColumn(); showColumnMenu = false"
                    class="w-full text-left px-4 py-2 text-sm text-red-400/80 hover:bg-red-500/10 hover:text-red-300 transition-colors flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 6h18"></path>
                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                    </svg>
                    Delete list
                </button>
            </div>
            }
        </div>
    </div>

    <!-- Drop List Container -->
    <div cdkDropList [id]="column.id" [cdkDropListData]="column.cards" [cdkDropListConnectedTo]="connectedTo"
        class="bg-black/30 rounded-b-xl border border-white/10 border-t-0 p-2 flex flex-col gap-2.5 overflow-y-auto custom-scrollbar min-h-[320px] max-h-[calc(100vh-220px)]"
        (cdkDropListDropped)="drop($event)" cdkScrollable>

        @for (card of column.cards; track card.id) {
        <app-nexus-card [card]="card" cdkDrag [cdkDragData]="card" (cdkDragStarted)="dragStarted.emit()"
            (cdkDragEnded)="dragEnded.emit()" [cdkDragStartDelay]="0" class="block">

            <!-- Custom Drag Placeholder -->
            <div *cdkDragPlaceholder class="card-drop-placeholder"></div>

            <!-- Custom Drag Preview (NO transitions, NO blur for performance) -->
            <div *cdkDragPreview
                class="p-3 bg-violet-900 border border-violet-500/50 shadow-2xl shadow-violet-500/30 rotate-2 cursor-grabbing rounded-xl">
                <h3 class="text-sm font-medium text-white">{{ card.title }}</h3>
            </div>

        </app-nexus-card>
        }

        <!-- Add Task / Template Buttons -->
        <div class="mt-1 space-y-2">
            @if (showTemplatePicker) {
            <div class="bg-slate-800/80 backdrop-blur-md border border-white/10 rounded-lg p-2 space-y-1">
                <div class="flex items-center justify-between px-2 py-1 mb-1">
                    <span class="text-[10px] font-bold text-white/40 uppercase tracking-widest">Select Template</span>
                    <button (click)="showTemplatePicker = false" class="text-white/40 hover:text-white">x</button>
                </div>
                @for (template of cardTemplates; track template.id) {
                <button (click)="useTemplate(template)"
                    class="w-full text-left px-3 py-2 rounded bg-white/5 hover:bg-white/10 text-xs text-white/80 transition-colors flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="text-emerald-300/90">
                        <path d="m12 3 2.4 4.86L20 8.7l-4 3.9.94 5.47L12 15.5l-4.94 2.57L8 12.6 4 8.7l5.6-.84L12 3z"></path>
                    </svg>
                    {{ template.template_name }}
                </button>
                }
                @if (cardTemplates.length === 0) {
                <div class="px-3 py-2 text-[10px] text-white/30 italic text-center">No card templates saved for this
                    board yet.</div>
                }
            </div>
            }

            <div class="flex gap-2">
                <button (click)="openAddTask()"
                    class="flex-1 py-1.5 rounded-lg border border-dashed border-white/10 text-white/40 text-xs hover:text-violet-300 hover:border-violet-500/30 hover:bg-violet-500/5 transition-all flex items-center justify-center gap-2">
                    <span>+</span> Add a card
                </button>
                <button (click)="showTemplatePicker = !showTemplatePicker" [class.bg-emerald-500]="showTemplatePicker"
                    class="px-2.5 py-1.5 rounded-lg border border-dashed border-white/10 text-white/40 text-xs hover:text-emerald-300 hover:border-emerald-500/30 hover:bg-emerald-500/5 transition-all flex items-center justify-center"
                    title="Templates">
                    <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 7h18"></path>
                        <path d="M7 3v8"></path>
                        <path d="M17 3v8"></path>
                        <rect x="3" y="7" width="18" height="14" rx="2"></rect>
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" width="11" height="11" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="text-emerald-300/90">
                        <path d="m12 3 2.4 4.86L20 8.7l-4 3.9.94 5.47L12 15.5l-4.94 2.57L8 12.6 4 8.7l5.6-.84L12 3z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

</div>
}
